'use strict';

var DPApp = require('../index');
var assert = require('assert');
var isApp = navigator.userAgent.match(/dp\//);
var localIds = [];
var adaptVersion = navigator.userAgent.match(/adapter\/([\d\.]+)/);
if (adaptVersion) {
  adaptVersion = adaptVersion[1];
}

var $ = require('jquery');
/**
 * UI Tests
 */
var query = DPApp.getQuery();
var config = {};
if (query.unsupportOldApp == 'true') {
  config.unsupportOldApp = true;
}

if (query.debug) {
  config.debug = true;
}

DPApp.config(config);

var uiTests = {
  share: {
    title: "分享标题",
    desc: "分享描述",
    content: "覆盖内容",
    feed: [DPApp.Share.WECHAT_FRIENDS, DPApp.Share.WECHAT_TIMELINE, DPApp.Share.WEIBO],
    image: "http://www.dpfile.com/toevent/img/16d05c85a71b135edc39d197273746d6.png",
    url: "http://m.dianping.com/?token=sometoken&abc=abc",
    success: function(result) {
      console.log("分享成功" + JSON.stringify(result));
    },
    fail: function(result) {
      console.log("分享失败" + JSON.stringify(result));
    }
  },
  alert: {
    title: '来自xxx页面（默认为空）',
    message: '领取红包成功',
    button: '好的',
    success: function() {
      alert('弹出窗已关闭');
    }
  },
  confirm: {
    title: '来自xxx页面（默认为空）',
    message: '真的要做这个操作么',
    okButton: '做做做',
    cancelButton: '容朕再想想',
    success: function(e) {
      if (e.ret == true) {
        alert('刚刚点击了确认');
      } else {
        alert('刚刚点击了取消');
      }
    }
  },
  prompt: {
    title: '来自xxx页面（默认为空）',
    text: 'hello',
    token: 'ddd',
    okButton: '好哒',
    cancelButton: '算啦',
    success: function(e) {
      var text = e.text;
      if (e.ret == true) {
        alert('刚刚输入了' + text);
      } else {
        alert('刚刚点击了取消');
      }
    },
    fail: function(e) {
      alert(JSON.stringify(e));
    }
  },
  actionSheet: {
    title: '请选择角色',
    selections: [
      '王大锤',
      '张全蛋',
      '马建国'
    ],
    cancelButton: '还是算了',
    success: function(e) {
      var canceled = e.selectedIndex == 3;
      if (canceled) {
        alert('刚刚点击了取消');
      } else {
        alert('刚刚选择了第' + e.selectedIndex + '项');
      }
    },
    fail: function(e) {
      alert(JSON.stringify(e));
    }
  },
  closeWindow: {

  },
  chooseImage: {
    count: 6,
    success: function(result) {
      alert('选择成功' + JSON.stringify(result.localIds));
      if (result.localIds) {
        localIds = result.localIds;
        result.localIds.forEach(function(localId) {
          var image = document.createElement('img');
          image.src = localId;
          document.getElementById('imageContainer').appendChild(image);
        });
      }
    },
    fail: function(result) {
      alert("选择失败" + JSON.stringify(result));
    }
  },
  initShare: {
    title: "分享标题",
    desc: "分享描述",
    content: "覆盖标题",
    image: "http://www.dpfile.com/toevent/img/16d05c85a71b135edc39d197273746d6.png",
    feed: [DPApp.Share.WECHAT_FRIENDS, DPApp.Share.QZONE, DPApp.Share.WEIBO, DPApp.Share.EMAIL],
    url: "http://m.dianping.com",
    success: function(result) {
      console.log("分享成功" + JSON.stringify(result));
    },
    fail: function(result) {
      console.log("分享失败" + JSON.stringify(result));
    }
  },
  sendSMS: {
    recipients: 13987654321,
    content: "短信内容",
    success: function(result) {
      console.log("短信发送成功" + JSON.stringify(result));
    },
    fail: function(result) {
      console.log("短信发送失败" + JSON.stringify(result));
    }
  },
  openScheme: {
    url: "dianping://websearch",
    extra: {
      "searchurl": "dianping://searchshoplist",
      "defaultKey": "demokey",
      "hotsuggesturl": "http://m.api.dianping.com/advancedsuggest.bin?cityid=1&mylat=31.215870&mylng=121.419100&myacc=0.000000",
      "keywordurl": "http://m.api.dianping.com/advancedsuggest.bin?cityid=1&mylat=31.215870&mylng=121.419100&myacc=0.000000"
    },
    success: function() {
      alert('openScheme success');
    }
  },
  uploadImage: [{
    name: "uploadImageOld",
    api: "uploadImage",
    config: {
      uploadUrl: 'http://m.api.dianping.com/shop/uploadfile.bin',
      compressFactor: 100,
      maxNum: 1,
      extra: {
        "businessType": "csc",
        "uploadurl": "http://kfonline.dianping.com/AndroidPhotoServlet"
      },
      handle: function(result) {
        console.log("图片上传处理" + JSON.stringify(result));
      },
      fail: function(result) {
        console.log("图片上传失败" + JSON.stringify(result));
      }
    }
  }, {
    name: "uploadImage",
    api: "uploadImage",
    config: function() {
      alert('upload with localId:' + localIds[0]);
      return {
        localId: localIds[0] || '',
        success: function(res) {
          var picKey = res.picKey;
          alert('上传图片成功，picKey:' + picKey);
        },
        fail: function(e) {
          alert('Error:' + JSON.stringify(e));
        }
      }
    }
  }, {
    name: "uploadMultiImage",
    api: "uploadImage",
    config: function() {
      alert('upload with localId:' + localIds[0]);
      return {
        localIds: localIds,
        success: function(res) {
          var picKeys = res.picKeys;
          alert('上传图片成功，picKeys:' + JSON.stringify(picKeys));
        },
        fail: function(e) {
          alert('Error:' + JSON.stringify(e));
        }
      }
    }
  }],
  isInstalledApp: {
    scheme: "weixin://",
    "package": "com.tencent.mobileqq",
    success: function(result) {
      if (result.installed) {
        alert("已安装");
      } else {
        alert("未安装");
      }
    }
  },
  login: {
    success: function(result) {
      console.log("登录成功：" + JSON.stringify(result));
    },
    fail: function() {
      console.log("登录失败");
    }
  },
  logout: {
    type: 0,
    success: function() {
      alert("登出成功");
    },
  },
  setPullDown: {
    success: function() {
      console.log("设置成功");
    },
    handle: function() {
      setTimeout(function() {
        DPApp.stopPullDown({
          success: function() {
            console.log("设置成功");
          },
          fail: function() {
            console.log("设置失败");
          }
        });
      }, 2000);
    },
    fail: function() {
      console.log("设置失败");
    }
  },
  scroll: [{
    name: "onScroll",
    api: "subscribe",
    config: {
      action: "scroll",
      success: function() {
        console.log('注册scroll成功');
        var $elem = document.getElementById('scrollElem')
        if (!$elem) {
          $elem = document.createElement('div');
          $elem.setAttribute('id', 'scrollElem');
          $elem.style.top = 0;
          document.body.appendChild($elem);
        }
      },
      handle: function(e) {
        console.log('scroll event handle:', e);
        var $elem = document.getElementById('scrollElem');
        $elem.style.top = e.offset + 'px';
      }
    }
  }, {
    name: "offScroll",
    api: "unsubscribe",
    config: {
      action: "scroll",
      success: function() {
        document.body.removeChild(document.getElementById('scrollElem'));
        console.log('取消注册scroll成功');
      }
    }
  }],
  appear: [{
    name: "onAppear",
    api: "subscribe",
    config: {
      action: "appear",
      success: function() {
        console.log('注册appear成功');
      },
      handle: function(e) {
        console.log('appear triggered');
        document.querySelector('.appear-count .count').innerHTML = +document.querySelector('.appear-count .count').innerHTML + 1;
      }
    }
  }, {
    name: "offAppear",
    api: "unsubscribe",
    config: {
      action: "appear",
      success: function() {
        console.log('取消注册appear成功');
      }
    }
  }],
  disappear: [{
    name: "onDisappear",
    api: "subscribe",
    config: {
      action: "disappear",
      success: function() {
        console.log('注册disappear成功');
      },
      handle: function(e) {
        console.log('disappear triggered');
        document.querySelector('.disappear-count .count').innerHTML = +document.querySelector('.disappear-count .count').innerHTML + 1;
      }
    }
  }, {
    name: "offDisappear",
    api: "unsubscribe",
    config: {
      action: "disappear",
      success: function() {
        console.log('取消注册disappear成功');
      }
    }
  }],
  jumpToScheme: [{
    name: "jumpToScheme",
    api: "jumpToScheme",
    config: {
      url: "dianping://websearch",
      extra: {
        "searchurl": "dianping://searchshoplist",
        "defaultKey": "demokey",
        "hotsuggesturl": "http://m.api.dianping.com/advancedsuggest.bin?cityid=1&mylat=31.215870&mylng=121.419100&myacc=0.000000",
        "keywordurl": "http://m.api.dianping.com/advancedsuggest.bin?cityid=1&mylat=31.215870&mylng=121.419100&myacc=0.000000"
      }
    }
  }, {
    name: "jumpToSchemeToHome",
    api: "jumpToScheme",
    config: {
      url: "dianping://websearch",
      toHome: true,
      extra: {
        "searchurl": "dianping://searchshoplist",
        "defaultKey": "demokey",
        "hotsuggesturl": "http://m.api.dianping.com/advancedsuggest.bin?cityid=1&mylat=31.215870&mylng=121.419100&myacc=0.000000",
        "keywordurl": "http://m.api.dianping.com/advancedsuggest.bin?cityid=1&mylat=31.215870&mylng=121.419100&myacc=0.000000"
      }
    }
  }],
  pickCity: {
    type: 1,
    success: function(result) {
      // TODO
      console.log(JSON.stringify(result));
      // {"errorCode":0,"cityId":"7","cityName":"深圳","status":"success","result":"next"}
    },
    fail: function(e) {
      console.log('pick city fail: ' + e);
    }
  },
  analyticsTag: {
    channel: 'XXX',
    key: 'XXX',
    value: {
      a: 'hello',
      b: 'world'
    },
  }
}

var uiTestContainer = document.getElementById('uiTests');

DPApp.ready(function() {
  function createButton(name, api, config) {
    var elem = document.createElement('div');
    elem.setAttribute('class', 'btn');
    elem.innerHTML = name;
    uiTestContainer.appendChild(elem);
    elem.addEventListener('click', function() {
      DPApp[api](typeof config == 'function' ? config() : config);
    });

    if (!DPApp.isSupport(api)) {
      elem.classList.add('disabled');
    }
  }
  Object.keys(uiTests).forEach(function(name) {
    if (uiTests[name].constructor == Array) {
      uiTests[name].forEach(function(item) {
        createButton(item.name, item.api, item.config);
      });
    } else {
      createButton(name, name, uiTests[name]);
    }
  });

  $("#all").on('click', function() {

    DPApp.all([
      DPApp.getUserInfo(),
      DPApp.getUA(),
      DPApp.getCityId()
    ]).then(function(results) {
      // handle results
      var info = results[0];
      var ua = results[1];
      var cityId = results[2];
      console.log(info, ua, cityId);
    }).catch(function(err) {
      // handle error
      console.log(err);
    });
  });
});



/**
 * Non-UI Tests
 */


/**
 * Set Cookies for web
 */
document.cookie = "cy=";
document.cookie = "cityid=1";


function isNumber(n) {
  return typeof n == "number" || /^\d+(\.\d+)?$/.test(n);
}

// describe("Common", function() {
//   it("ready", function(cb) {
//     var times = 1;

//     function done() {
//       console.log("called!" + times);
//       times++;
//       cb();
//     }
//     DPApp.ready(function() {
//       assert(DPApp._isReady);
//       done();
//     });
//   });

//   it("setTitle", function(done) {
//     DPApp.setTitle({
//       title: "new Title",
//       success: function() {
//         done();
//       }
//     });
//   });

//   it("getLocation", function(done) {
//     DPApp.getLocation({
//       success: function(result) {
//         assert(isNumber(result.lat));
//         assert(isNumber(result.lng));
//         done();
//       }
//     });
//   });
// });


// describe("App", function() {
//   function gteThan(version) {
//     var ua = DPApp.getUA();
//     var V = DPApp.Semver;
//     if (!ua.appVersion) {
//       return false;
//     }
//     return V.gte(ua.appVersion, version);
//   }

//   it("getUA", function(done) {
//     var ua = DPApp.getUA();
//     console.log("UA:", JSON.stringify(ua));
//     assert(JSON.stringify(ua));
//     done();
//   });


//   function failForGreaterThan(version, done) {
//     return function(err) {
//       if (gteThan(version)) {
//         done(err);
//       } else {
//         done();
//       }
//     }
//   }

//   it("getCityId", function(done) {
//     DPApp.getCityId({
//       success: function(info) {
//         assert(isNumber(info.cityId));
//         done();
//       },
//       fail: done
//     });
//   });

//   it("getUserInfo", function(done) {
//     DPApp.getUserInfo({
//       success: function(info) {
//         if (gteThan("7.1.0")) {
//           assert(isNumber(info.userId));
//         }
//         // assert("token" in info);
//         assert("dpid" in info);
//         done();
//       },
//       fail: failForGreaterThan("6.9.8", done)
//     }).catch(failForGreaterThan("6.9.8", done));
//   });

//   it("getCX", function(done) {
//     DPApp.getCX({
//       success: function(result) {
//         console.log("CX", JSON.stringify(result));
//         assert(result.cx.length > 400);
//         done();
//       }
//     }).catch(failForGreaterThan("6.9.8", done));
//   });

//   it("getVersion", function(done) {
//     DPApp.getVersion({
//       success: function(result) {
//         assert(result.version.match(/\d\.\d\.\d/));
//         done();
//       },
//       fail: failForGreaterThan("6.9.8", done)
//     });
//   });

//   it("getNetworkType", function(done) {
//     DPApp.getNetworkType({
//       success: function(result) {
//         assert.equal(result.networkType, "wifi");
//         done();
//       },
//       fail: failForGreaterThan("6.9.8", done)
//     });
//   });

//   it("getContactList", function(done) {
//     DPApp.getContactList({
//       success: function(result) {
//         var list = result.contactList;
//         var item = list[0];
//         assert(list.length > 0);
//         assert(typeof item.firstName, "string");
//         assert(typeof item.lastName, "string");
//         assert(typeof item.phone, "string");
//         done();
//       },
//       fail: failForGreaterThan("7.0.0", done)
//     }).catch(failForGreaterThan("7.0.0", done));
//   });

//   it("getRequestId", function(done) {
//     DPApp.getRequestId({
//       success: function(result) {
//         assert.equal(result.requestId.length, 36);
//         done();
//       },
//       fail: failForGreaterThan("7.0.0", done)
//     });
//   });

//   it("ajax", function(done) {
//     DPApp.ajax({
//       url: "http://m.api.dianping.com/indextabicon.bin?cityid=1&version=7.0.1",
//       method: "get",
//       keys: [
//         "List",
//         "HotName",
//         "Id",
//         "Icon",
//         "Title",
//         "Url",
//         "Type"
//       ],
//       success: function(res) {
//         var list = res.List;
//         var item = list[0];
//         assert(list);
//         assert("HotName" in item);
//         assert("Id" in item);
//         assert("Icon" in item);
//         assert("Title" in item);
//         assert("Url" in item);
//         assert("Type" in item);
//         done();
//       },
//       fail: failForGreaterThan("6.9.8", done)
//     });
//   });

//   it("retrieve without config", function(done) {
//     DPApp.retrieve({
//       key: "withoutConfig",
//       fail: function() {
//         done();
//       }
//     });
//   });


//   it("retrieve with config", function(done) {
//     DPApp.config({
//       bizname: "demo"
//     });
//     DPApp.retrieve({
//       key: "notExists",
//       success: function(result) {
//         assert.equal(result.value, "");
//         done();
//       },
//       fail: failForGreaterThan("7.5.0", done)
//     });
//   });

//   it("store/retrieve", function(done) {
//     DPApp.store({
//         key: "mykey",
//         value: "somevalue"
//       })
//       .then(function() {
//         return DPApp.retrieve({
//           key: "mykey"
//         });
//       })
//       .then(function(result) {
//         assert.equal(result.value, "somevalue");
//         done();
//       }).catch(failForGreaterThan("7.5.0", done));
//   });

//   it("subscribe", function(done) {
//     DPApp.subscribe({
//       action: "loginSuccess",
//       success: function(result) {
//         done();
//       },
//       handle: function() {
//         console.log("myevent triggered");
//       },
//       fail: failForGreaterThan("7.1.0", done)
//     });
//   });

//   it("subscribe custom events", function(done) {
//     DPApp.subscribe({
//       action: "myevent",
//       success: function(result) {
//         done();
//       },
//       handle: function() {
//         console.log("myevent triggered");
//       },
//       fail: failForGreaterThan("7.1.0", done)
//     });
//   });

//   it("tidyUrl", function() {
//     var cases = [
//       ["http://www.token.com", "http://www.token.com"],
//       ["http://www.token.com?blahtoken=abc&token=token&def=def&newtoken=newtoken&ghi=ghi", "http://www.token.com?blahtoken=abc&def=def&ghi=ghi"],
//       ["http://www.token.com?token=token&def=def&newtoken=newtoken&ghi=ghi&token=lalala&token=biubiubiu&newtoken=duang", "http://www.token.com?def=def&ghi=ghi"]
//     ]

//     cases.forEach(function(pair) {
//       assert.equal(DPApp._tidyUrlParams(pair[0]), pair[1]);
//     });
//   });

//   it("publish", function(done) {
//     DPApp.publish({
//       action: "myevent",
//       success: function(result) {
//         done();
//       },
//       fail: failForGreaterThan("7.1.0", done)
//     });
//   });

//   it("unsubscribe", function(done) {
//     DPApp.unsubscribe({
//       action: "loginSuccess",
//       success: function(result) {
//         done();
//       },
//       fail: failForGreaterThan("7.1.0", done)
//     });
//   });

//   it("unsubscribe custom events", function(done) {
//     DPApp.subscribe({
//       action: "myevent",
//       success: function(result) {
//         done();
//       },
//       handle: function() {
//         console.log("myevent triggered");
//       },
//       fail: failForGreaterThan("7.1.0", done)
//     });
//   });


//   it("downloadImage", function(done) {
//     DPApp.downloadImage({
//       imageUrl: "http://www.dpfile.com/toevent/img/ce066f1113f69fddb5b69355fee46bbe.jpg",
//       success: function() {
//         done();
//       },
//       fail: failForGreaterThan("7.1.0", done)
//     });
//   });

//   it("setBackgroundColor", function(done) {
//     DPApp.setBackgroundColor({
//       color: "3399dd",
//       success: function() {
//         done();
//       },
//       fail: failForGreaterThan("7.5.0", done)
//     });
//   });

//   it("setLLButton", function(done) {
//     DPApp.setLLButton({
//       text: "button1",
//       icon: "H5_Back",
//       success: function() {
//         done();
//       },
//       handle: function() {
//         DPApp.closeWindow();
//       },
//       fail: failForGreaterThan("7.1.0", done)
//     });
//   });

//   it("setLRButton", function(done) {
//     DPApp.setLRButton({
//       text: "button2",
//       success: function() {
//         done();
//       },
//       fail: failForGreaterThan("7.1.0", done)
//     });
//   });

//   it("setRLButton", function(done) {
//     DPApp.setRLButton({
//       text: "button3",
//       icon: "H5_Share",
//       success: function() {
//         done();
//       },
//       fail: failForGreaterThan("7.1.0", done)
//     });
//   });

//   it("setRRButton", function(done) {
//     DPApp.setRRButton({
//       text: "button4",
//       icon: "H5_Search",
//       success: function() {
//         done();
//       },
//       handle: function() {
//         console.log("RRButton clicked");
//       },
//       fail: failForGreaterThan("7.1.0", done)
//     });
//   });
// });