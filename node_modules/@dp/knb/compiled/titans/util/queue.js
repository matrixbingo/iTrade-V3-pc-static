//队列管理
module.exports = function queue(worker){
  var currentCallback = null;
  var q = {
    timeout: null,
    running : false,
    tasks: [],
    push: function(data, cb){
      var callback = cb || function(){};
      q.tasks.push({
        data: data,
        callback: callback
      });
      //当任务被放入队列后马上调用process处理，在process中如果running:false就可以立马运行
      setTimeout(function(){
        q.process();
      }, 0);
    },
    dequeue: function(){
      if(currentCallback){
        currentCallback();
      }else{
        q.running = false;
      }
    },
    process: function(){
      if(q.tasks.length && !q.running){
        var task = q.tasks.shift();
        q.running = true;
        currentCallback = function(){
          q.running = false;
          task.callback(task.data);
          q.process();
        };
        worker(task.data, currentCallback);
      }
    }
  };
  return q;
};