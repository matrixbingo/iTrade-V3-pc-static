###KNB项目结构

NPM包以'@dp/knb'的名字发布

KNB API[官方文档](http://docs.sankuai.com/doc/knb/knb-doc/api/)

* index.js npm包入口文件

* bundle.js - 构建knb webpack library入口文件

* lib js源代码

  1. common - 公共方法

    version.js 通过add_version.js自动生成版本信息

  2. dpapp - dpapp兼容knb实现
  3. mtnb - mtnb兼容knb实现
  4. api.js - knb api列表
  5. interface.js - knb提供默认的api实现以及loader等方法

* compiled - 生成出的es5代码。由于lib下以更简洁的es6语法书写，在以npm形式提供给业务方时，将编译成es5代码。这个文件夹会被gitignore。仅在prepublish时生成。

* build - 构建生成目录

  1. knb.js - 包含loader的，配合chunk目录下的文件，形成webpack的异步加载模式，自动判断环境加载对应的实现,此文件只是本地构建，真实开发可以直接引用线上js文件`http://www.dpfile.com/app/knb/build/knb.min.js`
  2. knb_dp.js，knb_mt.js - knb各个环境的独立版本,可用于已知当前环境后后端直接引用,线上地址为`http://www.dpfile.com/app/knb/build/knb_dp.min.js`,`http://www.dpfile.com/app/knb/build/knb_mt.min.js`

* demo - knb demo项目


###构建项目

* 配置npm registry，确保你可以获取dp,mtfe相关依赖,目前点评和美团NPM仓库已经同步

```
npm config set registry http://r.npm.sankuai.com
```

* npm install安装依赖

* 执行gulp

###分支说明

* master分支以NPM的包的形式开发，方便其他模块加载器以此为基础开发对应的封装实现
* release/1.0.0 利用点评发布系统，发布线上使用的资源，其中使用peon CI进行发布，具体发布参考`PEON发布`说明

###代码管理

[knb-sankuai](http://git.sankuai.com/mvc/projects/knb/repos/knb/browse) KNB官方仓库

[knb-code](http://code.dianpingoa.com/f2e/knb) 点评code仓库的代码只做线上发布使用

* 设置仓库名称

```
git remote add origin ssh://git@git.sankuai.com/knb/knb.git
git remote add code git@code.dianpingoa.com:f2e/knb.git
```

* 更改代码

```
git pull origin master //获取最新仓库代码
git checkout -b your_branch
git commit  //切换到自己分支修改代码&commit代码
git push origin your_branch --follow-tags //提交你的代码到sankuai仓库，通过PR合并进master

```

* KNB项目负责人将根据实际情况同步拉取sankuai master分支代码，合并到code release/1.0.0分支进行发布

```
  git pull origin master
  git checkout release/1.0.0
  git merge master
  git push code release/1.0.0  --follow-tags

  //代码发布到code release/1.0.0分支以后会自动构建，发布点评beta资源,
  //`http://s1.51ping.com/app/knb/build/knb.js`
  //在测试之后进行PPE,PRODUCT发布，同步线上所有knb资源到最新版本
```

#### peon发布说明

 peon发布只是在原有的master代码基础上，新增了静态发布&webpack发布的相关配置，

 *  配置f2eci.json文件，设置项目静态资源的路径等。
 *  更改webpack.config.js资源路径配置，主要是publicPath的设置

在此基础上，peon发布会讲正在demo目录作为一个静态项目发布上线，形成我们的DEMO页面`http://h5.dianping.com/app/knb/index.html`


#### build service发布说明

build service是美团平台的静态资源托管服务。

操作说明

```
npm version patch|release|major       # 让npm增加版本号，同时编译静态资源，并打上对应的git tag
git push origin master --follow-tags  # 推送到远程仓库
./notify-buildservice                 # 通知build-service更新资源
```

如果要知道一个资源的url地址，可以使用`makeurl.js`脚本：

```
node makeurl.js build/knb.js  # 默认不带参数则取build/knb.js
# 得到：http://s0.meituan.net/bs/knb/v1.0.24/knb.js
# 中间的`v1.0.24`表示当前commit所对应的tag，如果没有对应tag,则输出8位长的commitid.
```

注：对于本项目，仅支持对build目录下的内容托管.

对于buildservice的文件:

- 如果希望文件是非压缩混淆的，可修改bs的文件协议类型为`jsm`，对上例则是`http://s0.meituan.net/bs/knb/v1.0.24:jsm/knb.js`
- 如果总是希望拿master分支上的最新代码，可修改版本为`HEAD`，对上例则是`http://s0.meituan.net/bs/knb/HEAD/knb.js`
- 如果总希望拿某个分支上最新的代码，可修改为对应分支名如`release`，对上例则是`http://s0.meituan.net/bs/knb/release/knb.js`

### 基于build service的发布进阶流程

#### 如何发布一个自娱自乐的版本

```
git commit -m "my commit"
git push origin master
./notify-buildservice  # 通知build-service拉取代码
git rev-parse HEAD     # 假设得到ae5383cea3bc...,此时可以访问http://s0.meituan.net/bs/knb/ae5383cea/knb.js
```

#### 如何发布一个长期更新的版本

```
git co release
git commit -m "my release"
git push origin release:release   # 推送当前release分支到远程release分支
npm publish                       # 发布npm包
./notify-buildservice             # 通知build-service拉取代码
```

此时可访问`http://s0.meituan.net/bs/knb/release/knb.js`获取这个分支的对应knb文件，由于缓存原因，可能需要随机加一些querystring。

#### npm version 命令做了什么

`npm version`是npm自带的用于增加版本号的命令，knb发布流程要求knb开发者使用这个标准命令。其主要有三个子命令：

```
npm version patch    # 递增最后一位，如1.1.4
npm version release  # 递增中间位，同时最后一位清零,如1.2.0
npm version major    # 递增第一位，同时后两位清零,如2.0.0
```

这三个命令均可带`pre`前缀，表示只是试探性地发一个测试版，通常使用`pre`的版本号的特点为末尾有`-0`这样的数字，如：`v1.1.3-0`。
由于我们在package.json的`scripts`里有定义`version`的操作，故此时会触发`localbuild`操作并将编译生成的文件加入仓库。
最后npm会自行给我们进行`git commit`同时打上相应的`git tag`。这正是我们可以使用`/v1.0.25/knb.js`访问线上文件的原因。


#### pre-commit是什么

在`package.json`下我们依赖了`pre-commit`，在安装它时，会自动往`.git/hooks`下写钩子, 读取我们定义在`pre-commit`字段的操作。

```
pre-commit : [
  "test",        # 执行npm run test
  "ls",          # 执行npm run ls -> 即npm ls，检测当前node_modules下安装的内容是否符合package.json中的定义
  "localbuild",  # 执行npm run localbuild, 进行本地build
  "checkclean"   # 执行npm run checkclean，检查工作区是否干净
]
```

在进行`git commit`操作的时候，会自动触发`pre-commit`下的动作，只有都通过了，commit才会成功。

### 特别注意

- 永远不要尝试修改git历史，你会成为历史的罪人。
- 不要创建与tag同名或潜在会同名的分支。
